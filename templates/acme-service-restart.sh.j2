#!/bin/sh
# This file was autogenerated from a template by Ansible
# (see inofix.acme-setup role)

# only expect tools in this location..
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# report the execution date
date=$(date -u +'%Y-%m-%d %H:%M:%S')

# create a file to compare the certs to
lastrestart="{{ app__acme__home }}"/.acme-last-service-restart

# find registered services here
service_d="{{ acme__service_dir }}"
if [ ! -d "$service_d" ] ; then
    echo "$date Error restarting services - no service dir: '$service_d'."
    exit 0
fi

# see whether any certificate was created during the last month
if [ -f "$lastrestart" ] ; then
    new=$(find "{{ app__acme__config_dir }}" -newer $lastrestart -name "*.crt")
else
    new="restart, as there was no restart remembered"
fi

# if any new cert was found, service the registered services
if [ -n "$new" ] ; then

    echo "$date Restarting services.."

    for s in "$service_d/*" ; do
        . $s
    done

    # Remember the restart for future reference
    touch $lastrestart
fi

